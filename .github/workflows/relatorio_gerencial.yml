name: Relatório Gerencial Diesel

on:
  workflow_dispatch:
    inputs:
      report_id:
        description: "ID do relatorio em public.relatorios_gerados (Supabase B)"
        required: true
      periodo_inicio:
        description: "YYYY-MM-DD"
        required: false
      periodo_fim:
        description: "YYYY-MM-DD"
        required: false
      report_tipo:
        description: "tipo (diesel_gerencial)"
        required: false
        default: "diesel_gerencial"

jobs:
  gerar:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    env:
      # Supabase A/B (SECRETS)
      SUPABASE_A_URL: ${{ secrets.SUPABASE_A_URL }}
      SUPABASE_A_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_A_SERVICE_ROLE_KEY }}
      SUPABASE_B_URL: ${{ secrets.SUPABASE_B_URL }}
      SUPABASE_B_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_B_SERVICE_ROLE_KEY }}

      # ✅ compat: alguns scripts/clients usam os nomes "genéricos"
      SUPABASE_URL: ${{ secrets.SUPABASE_B_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_B_SERVICE_ROLE_KEY }}

      # Relatório
      REPORT_ID: ${{ inputs.report_id }}
      REPORT_TIPO: ${{ inputs.report_tipo }}
      REPORT_PERIODO_INICIO: ${{ inputs.periodo_inicio }}
      REPORT_PERIODO_FIM: ${{ inputs.periodo_fim }}
      REPORT_BUCKET: relatorios
      REPORT_OUTPUT_DIR: Relatorios_Diesel_Final
      REPORT_REMOTE_PREFIX: diesel
      DIESEL_SOURCE_TABLE: premiacao_diaria

      # Vertex (SECRETS)
      VERTEX_PROJECT_ID: ${{ secrets.VERTEX_PROJECT_ID }}
      VERTEX_LOCATION: ${{ secrets.VERTEX_LOCATION }}
      VERTEX_MODEL: ${{ secrets.VERTEX_MODEL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r scripts/requirements-gerencial.txt

      - name: Install Chromium (Playwright)
        run: |
          set -euo pipefail
          python -m playwright install --with-deps chromium

      - name: Check env (safe)
        run: |
          set -euo pipefail
          python - << 'PY'
          import os
          keys = [
            "SUPABASE_A_URL","SUPABASE_A_SERVICE_ROLE_KEY",
            "SUPABASE_B_URL","SUPABASE_B_SERVICE_ROLE_KEY",
            "REPORT_ID","REPORT_TIPO","REPORT_PERIODO_INICIO","REPORT_PERIODO_FIM",
            "REPORT_BUCKET","REPORT_OUTPUT_DIR","REPORT_REMOTE_PREFIX","DIESEL_SOURCE_TABLE",
            "VERTEX_PROJECT_ID","VERTEX_LOCATION","VERTEX_MODEL",
          ]
          for k in keys:
            v = os.getenv(k)
            # não printa segredos, só OK/MISSING
            print(f"{k}={'OK' if v else 'MISSING'}")
          PY

      - name: Run Gerencial
        run: |
          set -euo pipefail
          echo "Rodando relatorio_gerencial.py | REPORT_ID=$REPORT_ID | TIPO=$REPORT_TIPO | INI=$REPORT_PERIODO_INICIO | FIM=$REPORT_PERIODO_FIM"
          python -u scripts/relatorio_gerencial.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-gerencial-diesel
          path: |
            Relatorios_Diesel_Final/**
            *.log
